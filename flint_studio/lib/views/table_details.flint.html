<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlintStudio Table Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <main class="mx-auto max-w-7xl space-y-6 p-6 md:p-10">
    <header class="rounded-3xl border border-white/10 bg-slate-900/70 p-6">
      <p class="text-xs uppercase tracking-[0.28em] text-cyan-200">Table</p>
      <h1 class="mt-2 text-3xl font-extrabold">{{ tableName }}</h1>
      <p class="mt-2 text-sm text-slate-300">Database: {{ databaseName }} | Profile: {{ currentProfileName }} ({{ currentDriver }})</p>
      <div class="mt-4 flex flex-wrap gap-3">
        <a href="/databases/{{ databaseName }}?profile={{ currentProfileId }}" class="rounded-xl border border-white/20 bg-white/5 px-4 py-2 text-sm font-semibold">Back To Database</a>
        <form method="POST" action="/databases/{{ databaseName }}/tables/{{ tableName }}/drop" onsubmit="return confirm('Drop table {{ tableName }}? This cannot be undone.')">
          <input type="hidden" name="profile_id" value="{{ currentProfileId }}" />
          <input type="text" name="confirm_name" required placeholder="Type {{ tableName }}" class="rounded-xl border border-rose-300/30 bg-slate-950/70 px-3 py-2 text-xs text-rose-100 placeholder:text-rose-200/50" />
          <button type="submit" class="rounded-xl border border-rose-300/40 bg-rose-300/10 px-4 py-2 text-sm font-semibold text-rose-100">Drop Table</button>
        </form>
      </div>
    </header>

    {{ if successMessage != '' }}<section class="rounded-xl border border-emerald-300/40 bg-emerald-400/10 px-4 py-3 text-sm text-emerald-100">{{ successMessage }}</section>{{ endif }}
    {{ if errorMessage != '' }}<section class="rounded-xl border border-rose-300/40 bg-rose-400/10 px-4 py-3 text-sm text-rose-100">{{ errorMessage }}</section>{{ endif }}

    <section class="grid gap-4 md:grid-cols-3">
      <article class="rounded-2xl border border-white/10 bg-slate-900/70 p-5"><p class="text-xs text-slate-400">Columns</p><p class="mt-2 text-3xl font-bold text-cyan-200">{{ columnCount }}</p></article>
      <article class="rounded-2xl border border-white/10 bg-slate-900/70 p-5"><p class="text-xs text-slate-400">Rows Loaded</p><p class="mt-2 text-3xl font-bold text-cyan-200">{{ rowCount }}</p></article>
      <article class="rounded-2xl border border-white/10 bg-slate-900/70 p-5"><p class="text-xs text-slate-400">Inline Editing</p><p class="mt-2 text-xl font-bold {{ editable == 'true' ? 'text-emerald-200' : 'text-amber-200' }}">{{ editable == 'true' ? 'Enabled' : 'Disabled' }}</p></article>
    </section>

    <section class="rounded-2xl border border-white/10 bg-slate-900/70 p-6">
      <h2 class="text-base font-semibold text-rose-200">Drop Column</h2>
      <form method="POST" action="/databases/{{ databaseName }}/tables/{{ tableName }}/columns/drop" class="mt-3 flex flex-wrap gap-3" onsubmit="return confirm('Drop selected column? This cannot be undone.')">
        <input type="hidden" name="profile_id" value="{{ currentProfileId }}" />
        <select name="column_name" class="rounded-xl border border-white/15 bg-slate-950/85 px-4 py-2 text-sm">
          {{ for c in columns }}
            <option value="{{ c.COLUMN_NAME }}">{{ c.COLUMN_NAME }}</option>
          {{ endfor }}
        </select>
        <input type="text" name="confirm_name" required placeholder="Type selected column" class="rounded-xl border border-rose-300/30 bg-slate-950/70 px-3 py-2 text-xs text-rose-100 placeholder:text-rose-200/50" />
        <button type="submit" class="rounded-xl border border-rose-300/40 bg-rose-300/10 px-4 py-2 text-sm font-semibold text-rose-100">Drop Column</button>
      </form>
    </section>

    {{ if editable != 'true' }}
      <section class="rounded-xl border border-amber-300/40 bg-amber-400/10 px-4 py-3 text-sm text-amber-100">
        Editing requires exactly one primary key column. This table has none or composite primary key.
      </section>
    {{ endif }}

    <section class="overflow-hidden rounded-2xl border border-white/10 bg-slate-900/70">
      <header class="border-b border-white/10 bg-white/5 px-5 py-4"><h2 class="text-base font-semibold">Rows (press Enter to save cell)</h2></header>
      <div class="overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead id="rows-head" class="text-slate-300"></thead>
          <tbody id="rows-body" class="divide-y divide-white/5"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const columns = {{ columnNamesJson }};
    const rows = {{ rowsJson }};
    const editable = {{ editable == 'true' ? 'true' : 'false' }};
    const pkColumn = '{{ pkColumn }}';
    const profileId = '{{ currentProfileId }}';
    const databaseName = '{{ databaseName }}';
    const tableName = '{{ tableName }}';
    const head = document.getElementById('rows-head');
    const body = document.getElementById('rows-body');

    const headRow = document.createElement('tr');
    columns.forEach((col) => {
      const th = document.createElement('th');
      th.className = 'px-5 py-3';
      th.textContent = col;
      headRow.appendChild(th);
    });
    const stateTh = document.createElement('th');
    stateTh.className = 'px-5 py-3';
    stateTh.textContent = 'Status';
    headRow.appendChild(stateTh);
    const actionTh = document.createElement('th');
    actionTh.className = 'px-5 py-3';
    actionTh.textContent = 'Delete';
    headRow.appendChild(actionTh);
    head.appendChild(headRow);

    function setStatus(cell, text, colorClass) {
      cell.textContent = text;
      cell.className = `px-5 py-3 text-xs ${colorClass}`;
    }

    async function saveCell(rowObj, column, newValue, statusCell) {
      const changes = {};
      changes[column] = newValue;
      setStatus(statusCell, 'Saving...', 'text-sky-300');

      const response = await fetch(`/databases/${encodeURIComponent(databaseName)}/tables/${encodeURIComponent(tableName)}/rows`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          profile_id: profileId,
          pk_column: pkColumn,
          pk_value: rowObj[pkColumn],
          changes
        })
      });

      const payload = await response.json();
      if (response.ok && payload.ok) {
        setStatus(statusCell, 'Saved', 'text-emerald-300');
      } else {
        setStatus(statusCell, payload.message || 'Failed', 'text-rose-300');
      }
    }

    async function deleteRow(rowObj, statusCell, tr) {
      const keyText = rowObj[pkColumn] === null || rowObj[pkColumn] === undefined ? '' : String(rowObj[pkColumn]);
      const typed = prompt(`Type row key to delete: ${keyText}`);
      if (typed === null) return;
      setStatus(statusCell, 'Deleting...', 'text-amber-300');
      const response = await fetch(`/databases/${encodeURIComponent(databaseName)}/tables/${encodeURIComponent(tableName)}/rows/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          profile_id: profileId,
          pk_column: pkColumn,
          pk_value: rowObj[pkColumn],
          confirm_value: typed
        })
      });
      const payload = await response.json();
      if (response.ok && payload.ok) {
        tr.remove();
      } else {
        setStatus(statusCell, payload.message || 'Delete failed', 'text-rose-300');
      }
    }

    if (!rows || rows.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = columns.length + 2;
      td.className = 'px-5 py-4 text-slate-400';
      td.textContent = 'No rows found.';
      tr.appendChild(td);
      body.appendChild(tr);
    } else {
      rows.forEach((rowObj) => {
        const tr = document.createElement('tr');
        tr.className = 'transition hover:bg-white/5';

        const statusCell = document.createElement('td');
        setStatus(statusCell, editable ? 'Ready' : 'Read only', editable ? 'text-slate-400' : 'text-amber-300');

        columns.forEach((col) => {
          const td = document.createElement('td');
          td.className = 'px-5 py-3';
          const val = rowObj[col] === null || rowObj[col] === undefined ? '' : String(rowObj[col]);
          td.textContent = val;

          if (editable && col !== pkColumn) {
            td.contentEditable = 'true';
            td.classList.add('outline-none', 'focus:bg-sky-300/10', 'focus:ring-1', 'focus:ring-sky-300/40');
            td.addEventListener('keydown', async (event) => {
              if (event.key === 'Enter') {
                event.preventDefault();
                const newValue = td.textContent ?? '';
                await saveCell(rowObj, col, newValue, statusCell);
                rowObj[col] = newValue;
              }
            });
          }

          tr.appendChild(td);
        });

        tr.appendChild(statusCell);

        const actionCell = document.createElement('td');
        actionCell.className = 'px-5 py-3';
        if (editable) {
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'rounded border border-rose-300/40 bg-rose-300/10 px-2 py-1 text-xs font-semibold text-rose-100';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', async () => {
            await deleteRow(rowObj, statusCell, tr);
          });
          actionCell.appendChild(delBtn);
        } else {
          actionCell.textContent = '-';
          actionCell.classList.add('text-slate-500');
        }
        tr.appendChild(actionCell);
        body.appendChild(tr);
      });
    }
  </script>
</body>
</html>
